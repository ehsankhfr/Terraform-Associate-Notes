## ‚úÖ Terraform Provisioners

Provisioners in Terraform are used to **execute scripts or commands** on a local or remote system **after a resource is created or destroyed**. They're useful for bootstrapping configurations that **can't be easily handled with Terraform's declarative language**‚Äîsuch as installing software or modifying system files directly.

---

### ‚ö†Ô∏è Important Notes
- **Use provisioners as a last resort** ‚Äì they break Terraform‚Äôs declarative model and introduce imperative behavior.
- Provisioners are **not idempotent**‚ÄîTerraform can't track or rollback what they do.
- If a provisioner fails (e.g., script exits with non-zero), the associated resource is **marked as tainted**, and will be recreated on the next apply.

---

## üîó Connection Block

To use a **remote-exec** provisioner, you need to define a `connection` block to specify how Terraform should connect to the remote machine (e.g., via SSH):

```hcl
connection {
  type     = "ssh"
  user     = "ubuntu"
  private_key = file("~/.ssh/id_rsa")
  host     = self.public_ip
}
```

---

## üîß Types of Provisioners

### 1. üõ∞Ô∏è Remote Exec Provisioner

Runs **commands or scripts on the remote machine** after it has been provisioned. This is useful for:
- Installing software
- Configuring system settings
- Starting services
- Running post-deploy configuration scripts

#### Example: Install and Start Nginx on EC2

```hcl
resource "aws_instance" "web" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"

  connection {
    type        = "ssh"
    user        = "ubuntu"
    private_key = file("~/.ssh/id_rsa")
    host        = self.public_ip
  }

  provisioner "remote-exec" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get install -y nginx",
      "sudo systemctl start nginx"
    ]
  }
}
```

#### Example: Run a Script

```hcl
provisioner "remote-exec" {
  script = "scripts/configure_server.sh"
}
```

---

### 2. üñ•Ô∏è Local Exec Provisioner

Runs a **command on the machine where Terraform is executed**. This is helpful for:
- Triggering CI/CD scripts
- Notifying external systems (e.g., via `curl`)
- Creating files
- Running Ansible or external scripts after apply

#### Example: Echo a Message

```hcl
resource "null_resource" "local" {
  provisioner "local-exec" {
    command = "echo 'Provisioning complete!'"
  }
}
```

#### Example: Trigger Ansible Playbook

```hcl
resource "null_resource" "ansible_deploy" {
  provisioner "local-exec" {
    command = "ansible-playbook -i '${aws_instance.web.public_ip},' playbook.yml"
  }
}
```

---

## üß™ Use Case Scenarios

| Use Case                             | Use `remote-exec` | Use `local-exec` |
|--------------------------------------|--------------------|------------------|
| Install packages on a remote VM      | ‚úÖ Yes              | ‚ùå No            |
| Trigger local shell script           | ‚ùå No               | ‚úÖ Yes           |
| Notify external API after apply      | ‚ùå No               | ‚úÖ Yes           |
| Modify remote system files           | ‚úÖ Yes              | ‚ùå No            |
| Run post-deploy Ansible from local   | ‚ùå No               | ‚úÖ Yes           |

---

## üö´ When Not to Use Provisioners

Avoid provisioners when:
- You can use **user_data** in EC2 instead.
- You can use **cloud-init** for initialization.
- You can bake AMIs with **Packer**.
- You can define configurations using **configuration management tools** like Chef, Puppet, or Ansible (ideally run separately).

---

## üîÅ Tainted Resources

If a provisioner returns a non-zero exit status:
- Terraform will **mark the resource as tainted**, meaning it will be **destroyed and recreated** in the next apply.

Example of an error scenario:
```bash
Error: remote-exec provisioner error
‚îÇ Error running command 'bad-command': exit status 127
```

---

## üß± Chaining Multiple Provisioners

You can use multiple provisioners inside a resource:

```hcl
provisioner "remote-exec" {
  inline = ["echo 'Step 1'"]
}

provisioner "remote-exec" {
  inline = ["echo 'Step 2'"]
}
```

---

## ‚úÖ Summary

| Provisioner Type | Executes On | Common Use Cases |
|------------------|-------------|------------------|
| `remote-exec`    | Remote machine (e.g., EC2) | Install software, start services |
| `local-exec`     | Local machine (Terraform host) | Notify APIs, run Ansible, custom local scripts |
